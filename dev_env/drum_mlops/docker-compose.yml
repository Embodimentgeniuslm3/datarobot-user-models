version: '3'
services:
  drum:
    build: python3_sklearn
    image: python3_sklearn:latest
    depends_on: 
      - rabbit
    ports:
      - "8080:8080"
    environment:
      MONITOR: "True"
      MODEL_ID: "5f5dad02fc8b2f04b186f542"
      DEPLOYMENT_ID: "5f5dadcfab1dc70055554486"
      # MONITOR_SETTINGS: "spooler_type=filesystem;directory=/opt/mlops_spool;max_files=1;file_max_size=1024000"
      MONITOR_SETTINGS: "spooler_type=rabbitmq;rabbitmq_queue_url=amqp://drum:drum123@rabbit;rabbitmq_queue_name=drum"
    
    command: >
            /bin/bash -c "
                sleep 10    
                /opt/code/start_server.sh
            "
  mlops:
    image: "public-tools/mlops-agent:latest"
    depends_on: 
      - rabbit
    volumes:
      - ./mlops.agent.conf.yaml:/opt/datarobot/mlops/agent/conf/mlops.agent.conf.yaml
    environment:
      MLOPS_SERVICE_URL: "https://staging.datarobot.com"
      MLOPS_API_TOKEN: "NWQzY2M3M2M1YWZjOGE0NTcxNjA1ZTUwOlAtX0xJUllxcU52d0E5cnJER0U1RklUTlRib3ItWGFO"
      START_DELAY: "10"

  rabbit:
    image: "rabbitmq:3-management"
    ports:
      - "15672:15672"
      - "5672:5672"
    healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:15672"]
        interval: 30s
        timeout: 10s
        retries: 5
    environment:
      RABBITMQ_DEFAULT_USER: "drum"
      RABBITMQ_DEFAULT_PASS: "drum123"

